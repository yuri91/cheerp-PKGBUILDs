# Maintainer: Yuri Iozzelli <y.iozzelli@gmail.com>
pkgname=cheerp
pkgver=19.b461065
pkgrel=1
epoch=
pkgdesc="A C++ compiler for the Web"
arch=("x86_64")
url="leaningtech.com/cheerp"
license=('custom')
groups=()
depends=("python" "gcc-libs")
makedepends=("cmake" "ninja")
checkdepends=()
optdepends=()
provides=()
conflicts=()
replaces=()
backup=()
options=("!strip")
install=
changelog=
source=("git+https://github.com/leaningtech/cheerp-compiler.git"
	"git+https://github.com/leaningtech/cheerp-utils.git"
	"git+https://github.com/leaningtech/cheerp-newlib.git"
	"git+https://github.com/leaningtech/cheerp-libs.git"
)
md5sums=('SKIP'
	 'SKIP'
	 'SKIP'
	 'SKIP'
	)

pkgver() {
  cd "$_pkgname"
  echo $(git rev-list --count HEAD).$(git rev-parse --short HEAD)
}

: ${COMPILER_ONLY:=0}
: ${NO_CONFIGURE:=0}
: ${CLEAN_LIBS:=0}

build() {
	pushd $srcdir/cheerp-compiler

	if [ $NO_CONFIGURE == "0" ]
	then
		cmake -S llvm -B build -C llvm/CheerpCmakeConf.cmake \
			-DLLVM_ENABLE_PROJECTS=clang \
			-GNinja \
			-DCMAKE_BUILD_TYPE=Release \
			-DCMAKE_C_FLAGS_RELEASE="-O2" \
			-DCMAKE_CXX_FLAGS_RELEASE="-O2" \
			-DCMAKE_EXE_LINKER_FLAGS=-fuse-ld=lld \
			-DCMAKE_SHARED_LINKER_FLAGS=-fuse-ld=lld \
			-DCMAKE_MODULE_LINKER_FLAGS=-fuse-ld=lld \
			-DCMAKE_C_COMPILER=clang \
			-DCMAKE_CXX_COMPILER=clang++
	fi
	ninja -C build
	popd

	if [ $COMPILER_ONLY == "1" ]
	then
		return
	fi

	export CPPFLAGS=""
	export CFLAGS=""
	export CXXFLAGS=""
	export LDFLAGS=""
	export MAKEFLAGS=""
	pushd $srcdir/cheerp-newlib/newlib
	mkdir -p build_include/
	ln -sf "$srcdir/cheerp-utils/include/client" build_include/cheerp
	build_mode()
	{
		mkdir -p build_$1
		pushd build_$1
		if [ $NO_CONFIGURE == "0" ]
		then
			../configure --host=cheerp-$1 --with-cxx-headers="$srcdir/cheerp-compiler/libcxx/include" \
				--prefix=/opt/cheerp --enable-newlib-io-long-long \
				--enable-newlib-iconv --enable-newlib-iconv-encodings=utf-16,utf-8,ucs_2 \
				--enable-newlib-mb --enable-newlib-nano-formatted-io \
				"CHEERP_PREFIX=$srcdir/cheerp-compiler/build" \
				"CPPFLAGS=-I$srcdir/cheerp-newlib/newlib/build_include" \
				'AR=gcc-ar' 'RANLIB=gcc-ranlib'
		fi
		if [ $CLEAN_LIBS == "1" ]
		then
			make clean
		fi
		make
		popd
	}
	build_mode genericjs
	build_mode asmjs

	build_lib()
	{
		pushd build_$2
		mkdir -p build-bc-$1
		cd build-bc-$1
		ar x ../$1/$1.a
		$srcdir/cheerp-compiler/build/bin/llvm-link *.o -o $1.bc
		mkdir -p $srcdir/cheerp-compiler/build/lib/$2
		cp -v $1.bc "$srcdir/cheerp-compiler/build/lib/$2/$1.bc"
		cd ..
		rm -rf build-bc-$1
		popd
	}
	build_lib libc genericjs
	build_lib libm genericjs
	build_lib libc asmjs
	build_lib libm asmjs

	popd

	pushd $srcdir/cheerp-compiler

	mkdir -p build_cmake/Platform
	ln -sf "$srcdir/cheerp-utils/tools/Cheerp.cmake" build_cmake/Platform
	mkdir -p build_include/
	ln -sf "$srcdir/cheerp-utils/include/client" build_include/cheerp

	if [ $NO_CONFIGURE == "0" ]
	then
		cmake -S runtimes -B build_runtimes_js \
			-GNinja \
			-DCMAKE_BUILD_TYPE=Release \
			-DLLVM_DEFAULT_TARGET_TRIPLE="cheerp" \
			-DCMAKE_CXX_COMPILER_TARGET="cheerp" \
			-DCHEERP_PREFIX="$srcdir/cheerp-compiler/build/" \
			-DCMAKE_MODULE_PATH="$srcdir/cheerp-compiler/build_cmake" \
			-DCMAKE_CXX_FLAGS="-I$srcdir/cheerp-compiler/build_include -idirafter $srcdir/cheerp-newlib/newlib/build_genericjs/targ-include -idirafter $srcdir/cheerp-newlib/newlib/libc/include" \
			-C runtimes/CheerpCmakeConf.cmake
	fi
	if [ $CLEAN_LIBS == "1" ]
	then
		ninja -C build_runtimes_js clean
	fi
	ninja -C build_runtimes_js
	cp -v build_runtimes_js/lib/libc++.bc "$srcdir/cheerp-compiler/build/lib/genericjs/"
	cp -v build_runtimes_js/lib/libc++abi.bc "$srcdir/cheerp-compiler/build/lib/genericjs/"

	if [ $NO_CONFIGURE == "0" ]
	then
		cmake -S runtimes -B build_runtimes_wasm \
			-GNinja \
			-DCMAKE_BUILD_TYPE=Release \
			-DLLVM_DEFAULT_TARGET_TRIPLE="cheerp-wasm" \
			-DCMAKE_CXX_COMPILER_TARGET="cheerp-wasm" \
			-DCHEERP_PREFIX="$srcdir/cheerp-compiler/build/" \
			-DCMAKE_MODULE_PATH="$srcdir/cheerp-compiler/build_cmake" \
			-DCMAKE_CXX_FLAGS="-I$srcdir/cheerp-compiler/build_include -idirafter $srcdir/cheerp-newlib/newlib/build_genericjs/targ-include -idirafter $srcdir/cheerp-newlib/newlib/libc/include" \
			-C runtimes/CheerpCmakeConf.cmake
	fi
	if [ $CLEAN_LIBS == "1" ]
	then
		ninja -C build_runtimes_wasm clean
	fi
	ninja -C build_runtimes_wasm
	cp -v build_runtimes_wasm/lib/libc++.bc "$srcdir/cheerp-compiler/build/lib/asmjs/"
	cp -v build_runtimes_wasm/lib/libc++abi.bc "$srcdir/cheerp-compiler/build/lib/asmjs/"
	popd

	pushd $srcdir/cheerp-libs
	make -C stdlibs genericjs CHEERP_PREFIX="$srcdir/cheerp-compiler/build"
	make -C stdlibs asmjs CHEERP_PREFIX="$srcdir/cheerp-compiler/build"
	popd

}

package() {
	cd $srcdir/cheerp-compiler/

	DESTDIR="$pkgdir" ninja -C build install-distribution
	DESTDIR="$pkgdir" ninja -C build_runtimes_js install
	DESTDIR="$pkgdir" ninja -C build_runtimes_wasm install

	pushd $srcdir/cheerp-utils
	cmake -GNinja -B build -DCHEERP_PREFIX=/opt/cheerp -DCMAKE_INSTALL_PREFIX=$pkgdir/opt/cheerp
	ninja -C build install
	popd

	mkdir -p $pkgdir/usr/bin

	cat <<EOF > $pkgdir/usr/bin/cheerp
#!/bin/bash
/opt/cheerp/bin/clang \$@
EOF
	chmod a+x $pkgdir/usr/bin/cheerp
	cat <<EOF > $pkgdir/usr/bin/cheerp++
#!/bin/bash
/opt/cheerp/bin/clang++ \$@
EOF
	chmod a+x $pkgdir/usr/bin/cheerp++

	mkdir -p $pkgdir/usr/share/licenses/cheerp-compiler
	cp $srcdir/cheerp-compiler/llvm/LICENSE.TXT $pkgdir/usr/share/licenses/cheerp-compiler

	pushd $srcdir/cheerp-newlib/newlib
	make DESTDIR=$pkgdir -C build_genericjs install
	make DESTDIR=$pkgdir -C build_asmjs install
	popd

	pushd $srcdir/cheerp-libs
	mkdir -p $pkgdir/opt/cheerp/lib/genericjs/
	mkdir -p $pkgdir/opt/cheerp/lib/asmjs/
	make -C wasm install INSTALL_PREFIX="$pkgdir/opt/cheerp" CHEERP_PREFIX="$pkgdir/opt/cheerp"
	make -C webgles install INSTALL_PREFIX="$pkgdir/opt/cheerp" CHEERP_PREFIX="$pkgdir/opt/cheerp"
	make -C stdlibs install_genericjs INSTALL_PREFIX="$pkgdir/opt/cheerp" CHEERP_PREFIX="$srcdir/cheerp-compiler/build"
	make -C stdlibs install_asmjs INSTALL_PREFIX="$pkgdir/opt/cheerp" CHEERP_PREFIX="$srcdir/cheerp-compiler/build"
	popd
}
